## Web 框架实现总结

## 一、实验说明
本节内容最为整个框架的总结课程，主要通过回顾整个开发流程，对框架的模块再大致的过一遍，并讲解如何扩展与维护一个框架。

## 二、回顾所有的模块
### 2.1 WSGI
`WSGI` 是 `Web 服务器` 与框架交互的桥梁接口，负责在它们之间实现 `HTTP 请求` 体 和 `HTTP 响应` 体的传输。在实现这个模块我们是直接用了 `Werkzeug` 模块来实现，没有过多的去研究它的内部实现，其实它也并不复杂，内部的 `run_simple` 最后是用了 `socket` 实现了一个 `TCP` 隧道，数据交互遵守 `HTTP` 协议，并对客户端发过来的数据解析后封装为 `Request`，然后就到达我们的 `WSGI` 入口传给框架了，`Response` 则是 `Request` 的逆向思路实现而已。最开始我也是打算一切皆原生 `Python` 来实现，但最后考虑到知识跨度太大，深度略高，而且我们的核心是实现一个框架而不是实现一个完整的 `Web 服务端` 所有组件，所以这一次就用了第三发库进行开发，所以有兴趣的同学可以自行阅读 `Werkzeug` 源码加深理解，甚至自己用原生的 `Python` 实现一个 `Server` 容器与 `WSGI`。我个人的观点是对于自己感兴趣的东西，重复造轮子的能够加深自己对知识对原理的掌握，那我就会去做，而不是每次夸夸其谈的时候抛出一个观点或者一种技术，但是对其内部工作原理完全不懂，甚至连复现都无法做到。特指那些只会用工具的伪研究员。

### 2.2 URL 路由
路由概念之前已经讲的比较通俗易懂了，就是寻路，在一张二维表中，映射了 `URL` 与 `URL` 处理函数，寻路就是寻找到 `URL` 对应的处理函数，类似我们常说的路由器，里面也有一张路由表，记录了 `IP` 地址与 `MAC` 地址的映射，数据包发到路由器后，路由器通过这张表找到目标 `MAC` 地址对应的 `IP` 地址，然后再转发给内网中的目标机器。

### 2.3 视图
视图这个概念是有 `MVC` 设计模式中出来的，其实就是逻辑的封装而已，它单独放存在的时候没有什么用，需要联合控制器的调度才能发挥作用。

### 2.4 模版引擎
模版引擎之前说过有三种，我们这个框架只实现了最简单的 `置换型模版引擎`，其他的 `解释型` 和 `编译型`，同学们可以自己扩展，比如主流之一的 `Jinja` 模版，它是可以支持在模版中实现常用语法 `For` 和 `If` 这种语句的解释的。

### 2.5 会话维持
`HTTP` 的会话维持在久远的过去其实并不是用 `Session ID` 这种方式来存储的，过去的计算机历史长河中 `Cookie` 曾经出现过大量的安全事件，比如明文传输，所有信息都放在客户端中存放等等弊端，到现在演变为 `Session ID` 这种方式，有兴趣的同学可以去搜索一下这方面的安全事故，鞭策自己开发安全的代码，在我眼里一个不懂安全开发的程序员是不合格的。而这里要提一下 `Flask` 框架的 `request` 和 `session` ，这两个看似与请求分离的全局共用的对象，为什么能获取到对应客户端的请求和会话呢？不得不说作者代码功底实在是高，它内部其实是先做了线程隔离，再实现栈隔离的一个对象，有兴趣的同学可以去看看 `Flask` 的源码里这段 `Python 黑魔法`，然后可以的话，尝试去在自己的框架中实现吧，毕竟这种方式在实际开发中实在是高效太多。

### 2.6 URL 重定向
`URL` 重定向的实现非常简单，存在即合理，在一开始没有重定向的年代，还有一种比较有趣的写法来实现，就是写一段这样的 `JavaScript` 在响应体中
```html
<script> window.loaction.href = "which URL u wanna redirect"</script>
``` 
这种实现方式与 `Location` 的区别在于浏览器会渲染加载页面后，再去执行 `JavaScript` 代码，而不是像 `Location` 那样子在头部信息解析好之后就开始跳转。

### 2.7 JSON 接口
数据接口化的概念在程序开发中有一种叫 `RESTful API` 的概念，这种开发范式有的人支持，有的人反对，至于我们到底该不该用这种写法，其实不用在意别人的看法，而应该看应用开发的实际场景来判断是否需要使用，如果不为了跨平台，过度的数据接口化设计反而会加大程序开发复杂度，所以依旧是从需求来分析，细心的同学应该也发现我几乎所有模块都是从需求分析开始出模型，到设计模块的具体结构，最后再实际开发的，这也是软件工程中一种开发模式，依旧有的人支持，有的人反对，但又何必在意呢，适合自己并且存在即合理就够了。

### 2.8 文件下载
文件下载这个功能其实在我一开始的分析框架必备模块时是忽略掉的，但这并不影响我后面扩展这个功能的复杂度。因为从一开始框架的设计就是极地耦合度极高扩展性的，同学们不妨回顾整个框架代码，加入下载模块是在整个框架开发完毕之后再加进去的，那么在加进去的同时，是否有发现根本不需要在意原来的框架主体代码的，这也是我在大量的实际应用开发中被频繁变化的需求虐出来的结果，总结之后有一下几个点是我在开发中比较关注的
* 灵活性 -- 低耦合，可应付随时变化的需求，尽量设计一个不回因为需求变动而去重构的结构
* 可读性 -- 也就是低耦合度，该分开的必须分开，该语义化的语义化，你要考虑后面加入团队进来的人员上手速度，也要考虑离职之后其他人接手的速度，东西是你做的，是你的心血，你需要对它负责
* 维护性 -- 结合可读性来讲，我看到过大量的程序在用 `Python Web 框架` 开发时过度使用 `route` 来做 `URL` 处理，真的可读性和维护性都非常的差，对于一个不熟悉项目的人，加入他需要修改 `/index/user/infomation` 这个 `URL` 下的处理逻辑时，他需要在整个项目搜索这个路径，然后再去改，并且假如这个业务逻辑时临时的，基于原先的业务逻辑再扩展，短期上线过后又需要回退的话，`route` 这种没有可继承性并且与 `URL` 绑定死的开发模式，画面太美我不敢想象。

### 2.9 数据库连接模块
数据库模块又是一个比较可以吐槽的槽点了，对于普通程序员来讲，在业务逻辑涉及到数据库操作时，他们并不会对结果进行封装为一个统一的返回结构并且做异常处理，在生产环境中数据库操作因为一个异常未及时处理直接导致用户页面崩溃的场景实在太多了，对于用户体验来讲，效果实在是太差了。

### 2.10 异常处理
异常处理也是一个普通程序员经常会忽略或者觉得并不重要的模块，这是一个非常错误的认知，异常处理直接关乎的事代码的健壮性，就比如上面数据库那种情况，一个没有做异常处理的程序，对于可预见的异常抱着侥幸心理，要么觉得用户应该不会错误操作，要么觉得这种错误频率不高，索性不管的心态，不是一个合格程序员，程序代码是你的心血，你需要对它负责。

## 三、模块扩展
关于模块扩展，从上文可以了解到其实文件下载模块就是一个后期扩展了，大家在对这个框架进行扩展的时候，可以用类似的方法，把对应模块的返回值封装为一个 `Response` 然后在 `route` 中或者视图中作为返回就可以了，至于内部的逻辑，就需要自己分析设计实现了。


## 四、维护
说到维护，这其实是产品或者项目在生产环境中运行才会开始的阶段，也就是说，你的框架首先是要用，在实际场景中使用，给大量的人去使用，然后再收集对应的反馈，去修改，去扩展。

常用的方式是源码托管在 `Github`，然后通过 `ISSUS` 的方式收集反馈信息，然后跟踪维护到其关闭，这也是我比较推崇的方式。

## 五、结语
至此，我们这个开发框架的课程就到此结束了，最后一章其实只是一个实际应用的开发，更多的事框架的用法和编程思想上的东西，跟框架本身的开发已经没有多大的关系了，对于概念理论性的东西不会讲太多，所以根据我们的核心需求 `Python 实现轻量级 Web 框架`，我们的本次训练营其实到此就已经算是结束了，谢谢同学们一路学到这里，辛苦了，也祝你们在技术路上能越走越远，加油。

